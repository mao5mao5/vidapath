<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" 
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" 
                   xmlns:pro="http://www.liquibase.org/xml/ns/pro" 
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.1.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <property name="now" value="now()" dbms="h2"/>
    <property name="now" value="current_timestamp" dbms="postgresql"/>

    <changeSet author="cytomine" id="202512251000-1">
        <!-- 添加新的project_ids列，存储逗号分隔的项目ID列表 -->
        <addColumn tableName="temporary_access_token">
            <column name="project_ids" type="VARCHAR(1000)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="cytomine" id="202512251001-2">
        <!-- 将现有project_id的值复制到新的project_ids列 -->
        <sql>
            UPDATE temporary_access_token 
            SET project_ids = CAST(project_id AS VARCHAR);
        </sql>
    </changeSet>

    <changeSet author="cytomine" id="202512251002-3" dbms="postgresql">
        <!-- 设置新的project_ids列为非空 -->
        <addNotNullConstraint tableName="temporary_access_token" 
                              columnName="project_ids" 
                              defaultNullValue="0"/>
    </changeSet>

    <changeSet author="cytomine" id="202512251003-4">
        <!-- 删除旧的project_id列 -->
        <dropColumn tableName="temporary_access_token" columnName="project_id"/>
    </changeSet>

    <changeSet author="cytomine" id="202512251005-5">
        <!-- 为新的project_ids列创建索引 -->
        <createIndex indexName="project_ids_idx" tableName="temporary_access_token">
            <column name="project_ids"/>
        </createIndex>
    </changeSet>
</databaseChangeLog>